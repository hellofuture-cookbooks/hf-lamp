# Auto generated by Chef. Changes will be overwritten.

<VirtualHost *:<%= @params[:port] %>>
  ServerName <%= @params[:server_name] %>
  <% unless @params[:server_aliases].empty? %>ServerAlias <% @params[:server_aliases].each do |a| %><%= a %> <% end %><% end %>
  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    Options FollowSymLinks
    AllowOverride FileInfo Options
    AllowOverride All
  <% if node['apache']['version'] == '2.4' -%>
    Require all granted
  <% else -%>
    Order allow,deny
    Allow from all
  <% end -%>
   
    <% unless @params[:directory_directives].empty? %>
    <% @params[:directory_directives].each do |dir| %>
    <%= dir %>
    <% end %>
    <% end %>

    <% if @params[:passwd] %>
    AuthType Basic
    AuthName "Restricted Files"
    AuthBasicProvider file
    AuthUserFile /etc/apache2/passwds
    Require valid-user
    <% end %>
  </Directory>

  <Directorymatch "^/.*/\.git+/">
    Order deny,allow
    Deny from all
  <% if node['apache']['version'] == '2.4' -%>
    Require all denied
  <% else -%>
    Order deny,allow
    Deny from all
  <% end -%>
  </Directorymatch>
  <Files ~ "^\.git">
  <% if node['apache']['version'] == '2.4' -%>
    Require all denied
  <% else -%>
    Order deny,allow
    Deny from all
  <% end -%>
  </Files>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

  <% unless @params[:url_redirects].empty? %>
  <% @params[:url_redirects].each do |src, dest| %>
  Redirect <%= src %> <%= dest %>
  <% end %>
  <% end %>

  <% unless @params[:extra_directives].empty? %>
  <% @params[:extra_directives].each do |dir| %>
  <%= dir %>
  <% end %>
  <% end %>
  
    <% if @params[:vagrant] %>EnableSendfile Off<% end %>

  <% if @params[:canonical_redirect] %>
  # Canonical host, <%= @params[:server_name] %>
  RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
  RewriteCond %{HTTP_HOST}   !^$
  RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]
  <% end %>

  LogLevel info
  ErrorLog <%= @params[:log_path] %>/error.log
  CustomLog <%= @params[:log_path] %>/access.log <%= @params[:log_format] %>
</VirtualHost>
